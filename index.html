<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.14: http://docutils.sourceforge.net/" />
<title>Welcome to the Ceylan-Traces documentation</title>
<meta content="Traces, generic, general-purpose, helper code, library, layer" name="keywords" />
<link rel="stylesheet" href="pygments-default.css" type="text/css" />
<link rel="stylesheet" href="traces.css" type="text/css" />
</head>
<body>
<div class="document">


<span class="target" id="top"></span><p><span class="raw-html"><a name="traces_top"></a></span></p>
<p><span class="raw-html"><div class="banner"><p><em>Traces documentation</em> <a href="http://traces.esperide.org">browse latest</a> <a href="https://olivier-boudeville.github.io/Ceylan-Traces/traces.html">browse mirror</a> <a href="traces.pdf">get PDF</a> <a href="#traces_top">go to top</a> <a href="#traces_bottom">go to bottom</a> <a href="mailto:about(dash)traces(at)esperide(dot)com?subject=[Ceylan-Traces]%20Remark">mail us</a></p></div></span></p>
<p><span class="raw-html"><center><img src="traces-title.png" width="70%"></img></center></span>
</p>
<div class="section" id="technical-manual-of-the-ceylan-traces-layer">
<h1><a class="toc-backref" href="#id9">Technical Manual of the <tt class="docutils literal"><span class="pre">Ceylan-Traces</span></tt> Layer</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Organisation:</th><td class="field-body"><p class="first">Copyright (C) 2008-2018 Olivier Boudeville</p>
</td>
</tr>
<tr class="field"><th class="field-name">Contact:</th><td class="field-body"><p class="first">about (dash) traces (at) esperide (dot) com</p>
</td>
</tr>
<tr class="field"><th class="field-name">Creation Date:</th><td class="field-body"><p class="first">Wednesday, August 11, 2010</p>
</td>
</tr>
<tr class="field"><th class="field-name">Lastly Updated:</th><td class="field-body"><p class="first">Sunday, April 15, 2018</p>
</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body"><p class="first">Work in progress</p>
</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body"><p class="first">0.0.5</p>
</td>
</tr>
<tr class="field"><th class="field-name">Dedication:</th><td class="field-body"><p class="first">Users and maintainers of the <tt class="docutils literal">Traces</tt> layer.</p>
</td>
</tr>
<tr class="field"><th class="field-name">Abstract:</th><td class="field-body"><p class="first">The role of the <a class="reference external" href="http://traces.esperide.org/">Traces</a> layer (part of the <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan">Ceylan</a> project) is to provide trace services, so that the user can efficiently log, browse and search through detailed runtime messages that may be emitted concurrently (in parallel, and in a distributed way).</p>
<p class="last">We present here a short overview of these services, to introduce them to newcomers.
The next level of information is to read the corresponding <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Traces">source files</a>, which are intensely commented and generally straightforward.</p>
</td>
</tr>
</tbody>
</table>
<p></p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#technical-manual-of-the-ceylan-traces-layer" id="id9">Technical Manual of the <tt class="docutils literal"><span class="pre">Ceylan-Traces</span></tt> Layer</a><ul>
<li><a class="reference internal" href="#general-information" id="id10">General Information</a></li>
<li><a class="reference internal" href="#trace-emission" id="id11">Trace Emission</a></li>
<li><a class="reference internal" href="#trace-levels" id="id12">Trace Levels</a><ul>
<li><a class="reference internal" href="#trace-format" id="id13">Trace Format</a></li>
</ul>
</li>
<li><a class="reference internal" href="#trace-browsing" id="id14">Trace Browsing</a></li>
<li><a class="reference internal" href="#trace-implementation" id="id15">Trace Implementation</a><ul>
<li><a class="reference internal" href="#general-mode-of-operation" id="id16">General Mode of Operation</a></li>
<li><a class="reference internal" href="#trace-emitters" id="id17">Trace Emitters</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ending-word" id="id18">Ending Word</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="general-information">
<h2><a class="toc-backref" href="#id10">General Information</a></h2>
<p>This layer is in charge of providing <a class="reference external" href="http://erlang.org">Erlang</a> programs with the means of emitting, collecting, storing and browsing <em>applicative traces</em> (i.e. logs).</p>
<p>For that, various components have been designed and implemented, such as trace aggregator, emitter, listener, supervisor, etc.</p>
<p>They collectively constitute the <a class="reference external" href="http://traces.esperide.org/">Traces</a> layer, whose prerequisites are the <a class="reference external" href="http://wooper.esperide.org/">WOOPER</a> layer (for object-oriented primitives) and the <a class="reference external" href="http://myriad.esperide.org/">Myriad</a> layer (for many lower-level services).</p>
<p>The main purpose of this <strong>Traces</strong> layer is to provide adequate traces for distributed systems, and to ease their browsing. A few back-ends are available for that, from the direct reading of the (raw) trace files to considerably more user-friendly solutions, such as the generation of PDF reports or the use of a commercial tool named <a class="reference external" href="http://www.logmx.com/">LogMX</a>.</p>
<p>This layer defined a trace format of its own, supported by our Java-based parser for LogMX.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>In some cases, it may be convenient to have one's lower-level, debugging traces be directly output on the console.</p>
<p>Then, once the basic bugs are fixed (ex: the program is not crashing anymore), the full power of this <tt class="docutils literal">Traces</tt> layer can be best used, by switching these first, basic traces to the more advanced traces presented here.</p>
<p>To output (basic) console traces, one may use the <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Myriad/blob/master/src/utils/trace_utils.erl">trace_utils</a> module of the <tt class="docutils literal">Myriad</tt> layer. For example:</p>
<p><tt class="docutils literal"><span class="pre">trace_utils:debug_fmt(&quot;Hello</span> world <span class="pre">#~B&quot;,[2])</span></tt></p>
<p>Then, to anticipate a bit, switching to the mainstream, more advanced traces discussed here is just a matter of replacing, for a trace type T (ex: <tt class="docutils literal">debug</tt>), <tt class="docutils literal">trace_utils:T</tt> with <tt class="docutils literal"><span class="pre">?T</span></tt>, like in:</p>
<p class="last"><tt class="docutils literal"><span class="pre">?debug_fmt(&quot;Hello</span> world <span class="pre">#~B&quot;,[2])</span></tt>
(with no further change in the trace parameters).</p>
</div>
</div>
<div class="section" id="trace-emission">
<h2><a class="toc-backref" href="#id11">Trace Emission</a></h2>
<p>Typically the following include is needed so that an Erlang process can send traces:</p>
<pre class="literal-block">
-include(&quot;class_TraceEmitter.hrl&quot;).
</pre>
<p>Then sending-primitives can be used, such as:</p>
<pre class="literal-block">
?info(&quot;Hello world!&quot;)
</pre>
<p>or:</p>
<pre class="literal-block">
?info_fmt(&quot;The value ~B is the answer.&quot;,[MyValue])
</pre>
<p>Many API variations exist, to account for the various <a class="reference internal" href="#trace-levels">trace levels</a>, contexts, etc.</p>
<p>The trace macros used above can be fully toggled at build-time, on a per-module basis (if disabled, they incur zero runtime overhead, and no source change is required).</p>
</div>
<div class="section" id="trace-levels">
<h2><a class="toc-backref" href="#id12">Trace Levels</a></h2>
<p>There are six built-in levels for trace channels, of increasing severity:</p>
<table border="1" class="docutils">
<colgroup>
<col width="64%" />
<col width="36%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Trace Severity</th>
<th class="head">Mapped Level</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">debug</tt></td>
<td>6</td>
</tr>
<tr><td><tt class="docutils literal">trace</tt></td>
<td>5</td>
</tr>
<tr><td><tt class="docutils literal">info</tt></td>
<td>4</td>
</tr>
<tr><td><tt class="docutils literal">warning</tt></td>
<td>3</td>
</tr>
<tr><td><tt class="docutils literal">error</tt></td>
<td>2</td>
</tr>
<tr><td><tt class="docutils literal">fatal</tt></td>
<td>1</td>
</tr>
</tbody>
</table>
<p>There is also an addition trace severity, <tt class="docutils literal">void</tt>, that designates traces that shall be muted in all cases.</p>
<p>Its purpose is to provide another means of muting/unmuting some traces, instead of commenting out/uncommenting said traces.</p>
<p></p>
<div class="section" id="trace-format">
<h3><a class="toc-backref" href="#id13">Trace Format</a></h3>
<p>A set of traces is represented as an ordered stream of trace lines.</p>
<p>These traces are possibly exchanged over the network or stored in a file, whose extension is conventionally <tt class="docutils literal">.traces</tt>.</p>
<p>For example the traces for a test named <tt class="docutils literal">my_foobar_test</tt> are typically stored in a <tt class="docutils literal">my_foobar_test.traces</tt> file, generated by the trace aggregator in the directory from which the corresponding test was launched.</p>
<p>Each trace line is a raw text (hence not a binary content) made of a series of predefined fields, separated by the pipe (<tt class="docutils literal">|</tt>) character.</p>
<p>These fields are:</p>
<blockquote>
<ol class="arabic simple">
<li><strong>technical identifier of the emitter</strong>, as a string (ex: <tt class="docutils literal">&lt;9097.51.0&gt;</tt> for the PID of a distributed Erlang process)</li>
<li><strong>name of the emitter</strong> (ex: <tt class="docutils literal">&quot;Instance tracker&quot;</tt>)</li>
<li><strong>dotted categorization of the emitter</strong> (ex: <tt class="docutils literal">&quot;Core.Tracker.Instances&quot;</tt>); here for example the emitter is an element of the service in charge of the instances, which itself belongs to the tracker services, which themselves belong to the core services</li>
<li><strong>application-level timestamp</strong> (ex: operation count, relative tick, absolute timestep, or any complex, application-specific timestamp, etc.), possibly <tt class="docutils literal">none</tt> or <tt class="docutils literal">undefined</tt> if not applicable (ex: a simulation that would not be started yet)</li>
<li><strong>wall-clock timestamp</strong>, in the <tt class="docutils literal">&quot;Year/Month/Day Hour:Minute:Second&quot;</tt> format (ex: <tt class="docutils literal">&quot;2016/6/10 15:43:31&quot;</tt>)</li>
<li><strong>emitter location</strong>, as a string (ex: the name of the Erlang node, possibly including the name of the application use case, of the user and of the host; ex: <tt class="docutils literal">my_foobar_test_john&#64;hurricane.org</tt>)</li>
<li><strong>dotted categorization of the trace message</strong> itself (ex: <tt class="docutils literal">MyApp.MyTopic.MyTheme</tt>)</li>
<li><strong>severity of the trace message</strong> (mapped to an integer level, as discussed above)</li>
<li>the <strong>trace message</strong> itself, an arbitrary text of arbitrary length, possibly containing any number of instances of the field delimiter</li>
</ol>
</blockquote>
<p>Example of trace line (end of lines added for readability):</p>
<pre class="literal-block">
&lt;0.45.0&gt;|I am a test emitter of traces|TraceEmitter.Test|none|
2016/6/13 14:21:16|traceManagement_run-paul&#64;hurricane.foobar.org|
MyTest.SomeCategory|6|Hello debug world!
</pre>
<p>or:</p>
<pre class="literal-block">
&lt;9097.51.0&gt;|Instance tracker|Core.Tracker.Instances|14875|
2016/6/10 15:43:31|My_application_case-john&#64;hurricane.foobar.org|
Execution.Uncategorized|4|Creating a new root instance tracker
whose troubleshooting mode is enabled.
</pre>
<p></p>
</div>
</div>
<div class="section" id="trace-browsing">
<h2><a class="toc-backref" href="#id14">Trace Browsing</a></h2>
<p>Traces may be browsed thanks to either of the following supervision solutions (see <tt class="docutils literal">class_TraceSupervisor.erl</tt>):</p>
<ul class="simple">
<li><tt class="docutils literal">text_traces</tt>, itself available in two variations:</li>
</ul>
<blockquote>
<ul class="simple">
<li><tt class="docutils literal">text_only</tt> if wanting to have traces be directly written to disk as pure, yet human-readable, text</li>
<li><tt class="docutils literal">pdf</tt>, if wanting to read finally the traces in a generated PDF file</li>
</ul>
</blockquote>
<ul class="simple">
<li><tt class="docutils literal">log_mx_traces</tt>, for LogMX-compliant traces (the default) and discussed below</li>
</ul>
<p>Indeed the most usual tool that we use for trace browsing is <a class="reference external" href="http://www.logmx.com/">LogMX</a>, which we integrated:</p>
<img alt="logmx-interface.png" src="logmx-interface.png" />
<p>We implemented a Java-based parser of our trace format for LogMX (see <tt class="docutils literal">CeylanTraceParser.java</tt>):</p>
<img alt="logmx-levels.png" src="logmx-levels.png" />
<p>Traces can be browsed with this tool:</p>
<ul class="simple">
<li><strong>live</strong> (i.e. during the execution of the program), either from its start or upon connection to the running program whilst it is already running <a class="footnote-reference" href="#id4" id="id3">[1]</a> (see <tt class="docutils literal">class_TraceListener.erl</tt>)</li>
<li><strong>post mortem</strong> (i.e. after the program terminated for any reason, based on the trace file it left)</li>
</ul>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[1]</a></td><td>In which case the trace supervisor will receive transactionally a compressed version of all past traces then all new ones, hence with none possibly lost.</td></tr>
</tbody>
</table>
<p>The trace supervision solution can be switched at compile time (see the <tt class="docutils literal">TraceType</tt> defined in <tt class="docutils literal">traces/src/traces.hrl</tt>); the <tt class="docutils literal">Traces</tt> layer shall then be rebuilt.</p>
<p></p>
</div>
<div class="section" id="trace-implementation">
<h2><a class="toc-backref" href="#id15">Trace Implementation</a></h2>
<div class="section" id="general-mode-of-operation">
<h3><a class="toc-backref" href="#id16">General Mode of Operation</a></h3>
<p>All processes are able to emit traces, either by using standalone trace sending primitives (mostly for plain Erlang processes), or by inheriting from the <tt class="docutils literal">TraceEmitter</tt> class, in the (general) case of <a class="reference external" href="http://wooper.esperide.org">WOOPER</a>-based processes.</p>
<p>In the vast majority of cases, all these emitters send their traces to a single trace aggregator, in charge of collecting them and storing them on-disk, according to an adequate trace format.</p>
<p>This trace format can be parsed by various trace supervisors, the most popular being <a class="reference external" href="http://www.logmx.com">LogMX</a>.</p>
<p>Various measures have been taken in order to reduce the overhead induced by the overall trace system.</p>
<p>Notably traces are sent in a &quot;fire and forget&quot;, non-blocking manner (thanks to oneways, which are not specifically acknowledged). The number of messages exchanged is thus reduced, at the cost of a lesser synchronization of the traces (i.e. there is no strong guarantee that the traces will be ultimately recorded and displayed in the order of their emission in wallclock-time, as they will be directly and sequentially stored in their actual order of receiving by the trace aggregator <a class="footnote-reference" href="#id8" id="id7">[2]</a>, an order which itself depends on the potentially varied network latencies experienced from the potential multiple sources to the trace aggregator).</p>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[2]</a></td><td>For example, if both the trace aggregator and a process B are running on the same host, and if a process A, running on another host, emits a trace then sends a message to B so that B sends in turn a trace, then the trace from  B <em>might</em> in some cases be received - and thus be listed - by the aggregator <em>before</em> the trace for A (it depends on the network congestion, relative scheduling of processes, etc.).</td></tr>
</tbody>
</table>
</div>
<div class="section" id="trace-emitters">
<h3><a class="toc-backref" href="#id17">Trace Emitters</a></h3>
<p>When sending a trace, an emitter relies on its <tt class="docutils literal">trace_timestamp</tt> attribute, and sends a (binarised) string representation thereof (obtained thanks to the <tt class="docutils literal">~p</tt> quantifier of <tt class="docutils literal">io:format/2</tt> ). This allows the trace subsystem to support all kinds of application-specific traces (ex: integers, floats, tuples, strings, etc.).</p>
<p></p>
</div>
</div>
<div class="section" id="ending-word">
<h2><a class="toc-backref" href="#id18">Ending Word</a></h2>
<p>Have fun with Ceylan-Traces!</p>
<div class="figure">
<img alt="Traces logo" src="traces-title.png" />
</div>
<p><span class="raw-html"><a name="traces_bottom"></a></span></p>
</div>
</div>
</div>
</body>
</html>
